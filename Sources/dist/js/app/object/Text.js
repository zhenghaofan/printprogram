define(["knockout","mapping"],function(e,t){var n=function(n,r){var i=this;i.cvs=document.createElement("canvas"),i.ctx=i.cvs.getContext("2d"),i.parent=n,i.paddingLeft=5,i.paddingRight=5,i.paddingTop=5,i.paddingBottom=5,i.id=null,i.name=e.observable("文本"),i.type="text",i.isFixedWidth=e.observable(!1),i.zIndex=e.observable(0),i.offsetX=e.observable(100),i.offsetY=e.observable(100),i.angle=e.observable(0),i.ratio=e.observable(1),i.selected=e.observable(!1),i.width=e.observable(520),i.fontFamily=e.observable("sans-serif"),i.fontSize=e.observable(14),i.lineSpacing=e.observable(5),i.lineHeight=e.computed(function(){return i.fontSize()+i.lineSpacing()}),i.content=e.observable("如果 exec() 找到了匹配的文本，则返回一个结果\n数组。否则，返回 null。此数组的第 0 个元素是与正则表达式相匹配的文本，第 1 个元素是与 RegExpObject 的第 1 个子表达式相匹配的文本（如果有的话），第 2 个元素是与 RegExpObject 的第 2 个子表达式相匹配的文本（如果有的话），以此类推。除了数组元素和 length 属性之外，exec() 方法还返回两个属性。"),i.align=e.observable("left"),i.bold=e.observable(!1),i.italic=e.observable(!1),i.underline=e.observable(!1),i.font=e.computed(function(){var e=i.italic()?"italic":"normal",t=i.bold()?"bold ":"normal ";return e+" normal "+t+i.fontSize()+"px "+i.fontFamily()}),i.splitContent=e.computed(function(){var e=i.content();if(i.isFixedWidth()==0){i.ctx.font=i.font();var t=e.split("\n"),n=0,r;for(var s=0;s<t.length;s++){var o=t[s];r=i.ctx.measureText(o).width,n=Math.max(n,r)}return i.width(n),t}i.ctx.font=i.font();var t=e.split("/n"),u=[];for(var s=0;s<t.length;s++){var o=t[s];if(i.ctx.measureText(o).width<=i.width())u.push(o);else{var a=0,f,l;for(l=1;l<=o.length;l++)f=o.substring(a,l),i.ctx.measureText(f).width>i.width()&&(u.push(o.substring(a,l-1)),a=l-1);u.push(o.substring(a,l))}}return u}),i.height=e.computed(function(){return i.splitContent().length*i.lineHeight()-i.lineSpacing()}),i.canvasWidth=e.computed(function(){return i.width()+i.paddingLeft+i.paddingRight}),i.canvasHeight=e.computed(function(){return i.height()+i.paddingTop+i.paddingBottom}),i.autoUpdateEvent=null,i.UI_INFO=e.computed({read:function(){return{UI_LEFT_TOP_X:i.offsetX(),UI_LEFT_TOP_Y:i.offsetY(),UI_RIGHT_BOTTOM_X:i.offsetX()+i.canvasWidth(),UI_RIGHT_BOTTOM_Y:i.offsetY()+i.canvasHeight(),UI_TYPE:i.isFixedWidth()?"horizontal":"none"}},write:function(e){i.offsetX(e.UI_LEFT_TOP_X),i.offsetY(e.UI_LEFT_TOP_Y),i.width(e.UI_RIGHT_BOTTOM_X-e.UI_LEFT_TOP_X-i.paddingLeft-i.paddingRight)},owner:i}),i.init=function(){r=r||{};var e={include:["id","name","type","isFixedWidth","zIndex","offsetX","offsetY","angle","ratio","width","fontFamily","fontSize","lineSpacing","content","align","bold","italic","underline"]};r&&t.fromJS(r,e,i),i.redraw()},i.updateCanvas=function(){i.redraw(),i.parent&&i.parent.updateCanvas()},i.resizeCanvas=function(e,t){i.cvs.width=e,i.cvs.height=t,i.cvs.style.width=e+"px",i.cvs.style.height=e+"px"},i.redraw=function(){i.resizeCanvas(i.canvasWidth(),i.canvasHeight());var e=i.splitContent(),t=i.paddingTop;i.ctx.font=i.font(),i.ctx.textBaseline="top";for(var n=0;n<e.length;n++)i.ctx.fillText(e[n],i.paddingLeft,t+i.lineHeight()*n);return i.cvs},i.isInPoint=function(e,t){return e=e||window.app.stage.mouseX(),t=t||window.app.stage.mouseY(),i.offsetX()<=e&&e<=i.offsetX()+i.canvasWidth()&&i.offsetY()<=t&&t<=i.offsetY()+i.canvasHeight()},i.addAutoUpdateEvent=function(){i.autoUpdateEvent&&(i.autoUpdateEvent=i.cache.subscribe(function(){i.updateCanvas()}))},i.removeAutoUpdateEvent=function(){console.log("rem"),i.autoUpdateEvent&&(i.autoUpdateEvent=i.autoUpdateEvent.dispose())},i.init()};return n});