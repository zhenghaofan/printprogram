define(["jquery","knockout","app/tool/ControlPoint"],function(e,t,n){var r=function(r){var i=this;i.stage=r,i.cvs=i.stage.cvs,i.ctx=i.stage.ctx,n.prototype.ctx=i.ctx,i.e=new n,i.s=new n,i.w=new n,i.n=new n,i.nw=new n,i.ne=new n,i.sw=new n,i.se=new n,i.CONTROL_POINT_WIDTH=n.prototype.CONTROL_POINT_WIDTH,i.CONTROL_RECT_LINEWIDTH=1,i.CONTROL_RECT_LINECOLOR="#144DD4",i.target=null,i.UI_LEFT_TOP_X=t.observable(0),i.UI_LEFT_TOP_Y=t.observable(0),i.UI_RIGHT_BOTTOM_X=t.observable(0),i.UI_RIGHT_BOTTOM_Y=t.observable(0),i.UI_TYPE=t.observable("all"),i.x1=t.computed(function(){return i.UI_LEFT_TOP_X()}),i.x2=t.computed(function(){return(i.UI_RIGHT_BOTTOM_X()-i.UI_LEFT_TOP_X())/2+i.UI_LEFT_TOP_X()}),i.x3=t.computed(function(){return i.UI_RIGHT_BOTTOM_X()}),i.y1=t.computed(function(){return i.UI_LEFT_TOP_Y()}),i.y2=t.computed(function(){return(i.UI_RIGHT_BOTTOM_Y()-i.UI_LEFT_TOP_Y())/2+i.UI_LEFT_TOP_Y()}),i.y3=t.computed(function(){return i.UI_RIGHT_BOTTOM_Y()}),i.setCPPosition=t.computed(function(){i.e.x=i.x3(),i.e.y=i.y2(),i.s.x=i.x2(),i.s.y=i.y3(),i.w.x=i.x1(),i.w.y=i.y2(),i.n.x=i.x2(),i.n.y=i.y1(),i.nw.x=i.x1(),i.nw.y=i.y1(),i.ne.x=i.x3(),i.ne.y=i.y1(),i.sw.x=i.x1(),i.sw.y=i.y3(),i.se.x=i.x3(),i.se.y=i.y3()}),i.$body=e("body"),i.$document=e(document),i.init=function(){i.addAutoCursor(),e(i.stage.cvs).on("mousedown",i.removeAutoCursor),i.$document.on("mouseup",i.addAutoCursor)},i.resizeCanvas=function(e,t){i.cvs.width=e,i.cvs.style=e+"px",i.cvs.height=t,i.cvs.style=t+"px"},i.redraw=function(){return i.ctx.beginPath(),i.ctx.lineWidth=1,i.ctx.strokeStyle=i.CONTROL_RECT_LINECOLOR,i.ctx.save(),i.ctx.translate(.5,.5),i.ctx.moveTo(0,i.target.offsetY()),i.ctx.lineTo(i.stage.canvasWidth(),i.target.offsetY()),i.ctx.moveTo(i.target.offsetX(),0),i.ctx.lineTo(i.target.offsetX(),i.stage.canvasHeight()),i.ctx.rect(i.UI_LEFT_TOP_X(),i.UI_LEFT_TOP_Y(),i.UI_RIGHT_BOTTOM_X()-i.UI_LEFT_TOP_X(),i.UI_RIGHT_BOTTOM_Y()-i.UI_LEFT_TOP_Y()),i.ctx.stroke(),i.ctx.restore(),i.UI_TYPE()=="all"?(i.e.print(),i.s.print(),i.w.print(),i.n.print(),i.nw.print(),i.ne.print(),i.sw.print(),i.se.print()):i.UI_TYPE()=="horizontal"?(i.e.print(),i.w.print()):i.UI_TYPE()=="vertical"&&(i.s.print(),i.n.print()),i.cvs},i.isInPoint=function(e,t){return e=e||i.stage.mouseX()||0,t=t||i.stage.mouseY()||0,i.ctx.beginPath(),i.ctx.rect(i.UI_LEFT_TOP_X(),i.UI_LEFT_TOP_Y(),i.UI_RIGHT_BOTTOM_X()-i.UI_LEFT_TOP_X(),i.UI_RIGHT_BOTTOM_Y()-i.UI_LEFT_TOP_Y()),i.ctx.isPointInPath(e,t)},i.update=function(e,t,n){i.target=n;var r=n.UI_INFO();i.UI_LEFT_TOP_X(r.UI_LEFT_TOP_X),i.UI_LEFT_TOP_Y(r.UI_LEFT_TOP_Y),i.UI_RIGHT_BOTTOM_X(r.UI_RIGHT_BOTTOM_X),i.UI_RIGHT_BOTTOM_Y(r.UI_RIGHT_BOTTOM_Y),i.UI_TYPE(r.UI_TYPE||"all")},i.hide=function(){i.UI_LEFT_TOP_X(-1),i.UI_LEFT_TOP_Y(-1),i.UI_RIGHT_BOTTOM_X(-1),i.UI_RIGHT_BOTTOM_Y(-1)},i.autoCursor=function(){if(i.UI_TYPE()=="all"){if(i.e.isInPoint())return i.$body.css("cursor","e-resize"),!0;if(i.s.isInPoint())return i.$body.css("cursor","s-resize"),!0;if(i.w.isInPoint())return i.$body.css("cursor","w-resize"),!0;if(i.n.isInPoint())return i.$body.css("cursor","n-resize"),!0;if(i.nw.isInPoint())return i.$body.css("cursor","nw-resize"),!0;if(i.ne.isInPoint())return i.$body.css("cursor","ne-resize"),!0;if(i.sw.isInPoint())return i.$body.css("cursor","sw-resize"),!0;if(i.se.isInPoint())return i.$body.css("cursor","se-resize"),!0}else if(i.UI_TYPE()=="horizontal"){if(i.e.isInPoint())return i.$body.css("cursor","e-resize"),!0;if(i.w.isInPoint())return i.$body.css("cursor","w-resize"),!0}else if(i.UI_TYPE()=="vertical"){if(i.s.isInPoint())return i.$body.css("cursor","s-resize"),!0;if(i.n.isInPoint())return i.$body.css("cursor","n-resize"),!0}i.$body.css("cursor","default")},i.removeAutoCursor=function(){e(i.stage.cvs).off("mousemove",i.autoCursor)},i.addAutoCursor=function(){e(i.stage.cvs).off("mousemove",i.autoCursor),e(i.stage.cvs).on("mousemove",i.autoCursor)},i.onmousedown=function(){if(i.UI_TYPE()=="all"){if(i.e.isInPoint())return i.test_line=i.x1(),i.$document.on("mousemove",i.on_drag_e),i.$document.one("mouseup",i.on_end_drag_e),i.$body.css("cursor","e-resize"),!0;if(i.s.isInPoint())return i.test_line=i.y1(),i.$document.on("mousemove",i.on_drag_s),i.$document.one("mouseup",i.on_end_drag_s),i.$body.css("cursor","s-resize"),!0;if(i.w.isInPoint())return i.test_line=i.x3(),i.$document.on("mousemove",i.on_drag_w),i.$document.one("mouseup",i.on_end_drag_w),i.$body.css("cursor","w-resize"),!0;if(i.n.isInPoint())return i.test_line=i.y3(),i.$document.on("mousemove",i.on_drag_n),i.$document.one("mouseup",i.on_end_drag_n),i.$body.css("cursor","n-resize"),!0;if(i.nw.isInPoint())return i.test_x=i.x3(),i.test_y=i.y3(),i.$document.on("mousemove",i.on_drag_nw),i.$document.one("mouseup",i.on_end_drag_nw),i.$body.css("cursor","nw-resize"),!0;if(i.ne.isInPoint())return i.test_x=i.x1(),i.test_y=i.y3(),i.$document.on("mousemove",i.on_drag_ne),i.$document.one("mouseup",i.on_end_drag_ne),i.$body.css("cursor","ne-resize"),!0;if(i.sw.isInPoint())return i.test_x=i.x3(),i.test_y=i.y1(),i.$document.on("mousemove",i.on_drag_sw),i.$document.one("mouseup",i.on_end_drag_sw),i.$body.css("cursor","sw-resize"),!0;if(i.se.isInPoint())return i.test_x=i.x1(),i.test_y=i.y1(),i.$document.on("mousemove",i.on_drag_se),i.$document.one("mouseup",i.on_end_drag_se),i.$body.css("cursor","se-resize"),!0}else if(i.UI_TYPE()=="horizontal"){if(i.e.isInPoint())return i.test_line=i.x1(),i.$document.on("mousemove",i.on_drag_e),i.$document.one("mouseup",i.on_end_drag_e),i.$body.css("cursor","e-resize"),!0;if(i.w.isInPoint())return i.test_line=i.x3(),i.$document.on("mousemove",i.on_drag_w),i.$document.one("mouseup",i.on_end_drag_w),i.$body.css("cursor","w-resize"),!0}else if(i.UI_TYPE()=="vertical"){if(i.s.isInPoint())return i.test_line=i.y1(),i.$document.on("mousemove",i.on_drag_s),i.$document.one("mouseup",i.on_end_drag_s),i.$body.css("cursor","s-resize"),!0;if(i.n.isInPoint())return i.test_line=i.y3(),i.$document.on("mousemove",i.on_drag_n),i.$document.one("mouseup",i.on_end_drag_n),i.$body.css("cursor","n-resize"),!0}if(i.isInPoint())return i.offset_top_left_x=i.stage.mouseX()-i.UI_LEFT_TOP_X(),i.offset_top_left_y=i.stage.mouseY()-i.UI_LEFT_TOP_Y(),i.offset_bottom_right_x=i.stage.mouseX()-i.UI_RIGHT_BOTTOM_X(),i.offset_bottom_right_y=i.stage.mouseY()-i.UI_RIGHT_BOTTOM_Y(),i.$document.on("mousemove",i.on_drag),i.$document.one("mouseup",i.on_end_drag),i.$body.css("cursor","move"),!0},i.on_end_drag=function(){i.$document.off("mousemove",i.on_drag),i.$body.css("cursor","default")},i.on_drag=function(){i.target.offsetX(i.stage.mouseX()-i.offset_top_left_x),i.target.offsetY(i.stage.mouseY()-i.offset_top_left_y),i.stage.updateCanvas()},i.on_drag_e=function(){var e={UI_LEFT_TOP_X:Math.min(i.test_line,i.stage.mouseX()),UI_LEFT_TOP_Y:i.y1(),UI_RIGHT_BOTTOM_X:Math.max(i.test_line,i.stage.mouseX()),UI_RIGHT_BOTTOM_Y:i.y3()};i.target.UI_INFO(e),i.target.updateCanvas()},i.on_end_drag_e=function(){i.$document.off("mousemove",i.on_drag_e),i.$body.css("cursor","default")},i.on_drag_s=function(){var e={UI_LEFT_TOP_X:i.x1(),UI_LEFT_TOP_Y:Math.min(i.test_line,i.stage.mouseY()),UI_RIGHT_BOTTOM_X:i.x3(),UI_RIGHT_BOTTOM_Y:Math.max(i.test_line,i.stage.mouseY())};i.target.UI_INFO(e),i.target.updateCanvas()},i.on_end_drag_s=function(){i.$document.off("mousemove",i.on_drag_s),i.$body.css("cursor","default")},i.on_drag_w=function(){var e={UI_LEFT_TOP_X:Math.min(i.test_line,i.stage.mouseX()),UI_LEFT_TOP_Y:i.y1(),UI_RIGHT_BOTTOM_X:Math.max(i.test_line,i.stage.mouseX()),UI_RIGHT_BOTTOM_Y:i.y3()};i.target.UI_INFO(e),i.target.updateCanvas()},i.on_end_drag_w=function(){i.$document.off("mousemove",i.on_drag_w),i.$body.css("cursor","default")},i.on_drag_n=function(){var e={UI_LEFT_TOP_X:i.x1(),UI_LEFT_TOP_Y:Math.min(i.test_line,i.stage.mouseY()),UI_RIGHT_BOTTOM_X:i.x3(),UI_RIGHT_BOTTOM_Y:Math.max(i.test_line,i.stage.mouseY())};i.target.UI_INFO(e),i.target.updateCanvas()},i.on_end_drag_n=function(){i.$document.off("mousemove",i.on_drag_n),i.$body.css("cursor","default")},i.on_drag_nw=function(){var e={UI_LEFT_TOP_X:Math.min(i.test_x,i.stage.mouseX()),UI_LEFT_TOP_Y:Math.min(i.test_y,i.stage.mouseY()),UI_RIGHT_BOTTOM_X:Math.max(i.test_x,i.stage.mouseX()),UI_RIGHT_BOTTOM_Y:Math.max(i.test_y,i.stage.mouseY())};i.target.UI_INFO(e),i.target.updateCanvas()},i.on_end_drag_nw=function(){i.$document.off("mousemove",i.on_drag_nw),i.$body.css("cursor","default")},i.on_drag_ne=function(){var e={UI_LEFT_TOP_X:Math.min(i.test_x,i.stage.mouseX()),UI_LEFT_TOP_Y:Math.min(i.test_y,i.stage.mouseY()),UI_RIGHT_BOTTOM_X:Math.max(i.test_x,i.stage.mouseX()),UI_RIGHT_BOTTOM_Y:Math.max(i.test_y,i.stage.mouseY())};i.target.UI_INFO(e),i.target.updateCanvas()},i.on_end_drag_ne=function(){i.$document.off("mousemove",i.on_drag_ne),i.$body.css("cursor","default")},i.on_drag_sw=function(){var e={UI_LEFT_TOP_X:Math.min(i.test_x,i.stage.mouseX()),UI_LEFT_TOP_Y:Math.min(i.test_y,i.stage.mouseY()),UI_RIGHT_BOTTOM_X:Math.max(i.test_x,i.stage.mouseX()),UI_RIGHT_BOTTOM_Y:Math.max(i.test_y,i.stage.mouseY())};i.target.UI_INFO(e),i.target.updateCanvas()},i.on_end_drag_sw=function(){i.$document.off("mousemove",i.on_drag_sw),i.$body.css("cursor","default")},i.on_drag_se=function(){var e={UI_LEFT_TOP_X:Math.min(i.test_x,i.stage.mouseX()),UI_LEFT_TOP_Y:Math.min(i.test_y,i.stage.mouseY()),UI_RIGHT_BOTTOM_X:Math.max(i.test_x,i.stage.mouseX()),UI_RIGHT_BOTTOM_Y:Math.max(i.test_y,i.stage.mouseY())};i.target.UI_INFO(e),i.target.updateCanvas()},i.on_end_drag_se=function(){i.$document.off("mousemove",i.on_drag_se),i.$body.css("cursor","default")},i.init()};return r});