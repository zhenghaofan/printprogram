define(["jquery","knockout","mapping","app/Ruler","app/Doc","app/UIController","app/Util"],function(e,t,n,r,i,s,o){var u=function(){var e=this;e.cvs=document.getElementById("cvs"),e.ctx=e.cvs.getContext("2d"),e.docCounter=0,e.mouseX=t.observable(0),e.mouseY=t.observable(0),e.canvasWidth=t.observable(0),e.canvasHeight=t.observable(0),e.curDocIndex=t.observable(0),e.docs=t.observableArray(),e.curDoc=t.computed(function(){return e.docs()[e.curDocIndex()]},e),e.ruler=r,e.ui=new s(e),e.init=function(){e.resizeCanvas(e.canvasWidth(),e.canvasHeight()),e.cvs.addEventListener("mousemove",e.updateMouseXY)},e.loadData=function(r){var s={include:["docCounter","docs"],docs:{key:function(e){return t.utils.unwrapObservable(e.id)},create:function(t){return new i(e,t.data)}}};r&&(n.fromJS(r,s,e),e.selectLastDoc(),e.updateCanvas())},e.getData=function(){return n.toJS(e)},e.setCurDoc=function(t){e.curDocIndex(e.docs.indexOf(t)),o.Event.dispatch("changDoc",e,e.curDoc()),e.updateCanvas(),e.updateRuler()},e.removeDoc=function(t){e.docs.remove(t),e.selectLastDoc()},e.selectLastDoc=function(){var t=e.docs().length-1;t=t<0?0:t,e.curDocIndex(t),o.Event.dispatch("changDoc",e,e.curDoc()),e.updateCanvas(),e.updateRuler()},e.updateMouseXY=function(t){var n=e.cvs.getBoundingClientRect();e.mouseX(Math.round(t.clientX-n.left*(e.cvs.width/n.width))),e.mouseY(Math.round(t.clientY-n.top*(e.cvs.height/n.height)))},e.resizeCanvas=function(t,n){e.canvasWidth(t),e.canvasHeight(n),e.cvs.width=t,e.cvs.height=n,e.cvs.style.width=t+"px",e.cvs.style.height=n+"px"},e.addDoc=function(t){return e.docs.push(new i(e,t)),e.selectLastDoc(),e},e.updateCanvas=function(){e.redraw()},e.updateRuler=function(){var t=e.curDoc();t?e.ruler.update(t.width(),t.height(),t.ratio()):e.ruler.update(0,0,1)},e.redraw=function(){var t=e.curDoc();t?(e.resizeCanvas(t.width(),t.height()),t.redraw(),e.updateUI()):e.resizeCanvas(0,0)},e.updateUI=function(){var t=e.curDoc();t&&t.focusObject()?(e.ui.update(t.width(),t.height(),t.focusObject()),e.ui.redraw()):e.ui.hide()},e.set_doc_scroll_offset=function(e,t){},e.getDoc=function(){return e.curDoc()},e.init()};return new u});